<head>
    <link href="https://vjs.zencdn.net/7.11.4/video-js.css" rel="stylesheet"/>

    <!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
    <!-- <script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script> -->
</head>

<body>
<video-js id=vid1 width=600 height=300 class="vjs-default-skin" controls>
</video-js>

<script src="https://vjs.zencdn.net/7.11.4/video.min.js"></script>
<script>
    const streamingPort = 18094 //corresponds to the StreamingPort in the config of pp node
    const fileHash = '6f044130c0da4a94ed0c3231db72f3ff04c430fa5dd78416e14e7e86e7d5c294';
    const walletAddress = 'st1ddyjr2mymrle6k0uur9vha2v6z2ruajwv76fqn';
    const p2pAddress = 'stsdsp2p17u2aw48v8runse3t2e355y0pkcddch7dvmmcx4';
    let streamInfo;
    httpGetAsync(`http://localhost:${streamingPort}/fileStorageInfo/${fileHash}`, function(responseText) {
        streamInfo = JSON.parse(responseText);
        console.log(streamInfo)
        playVideo();
    })

    function playVideo() {
        var player = videojs('vid1');
        videojs.Hls.xhr.beforeRequest = function (options) {
            const videoSegment = options.uri.split('/').pop();
            console.log(videoSegment)
            const sliceInfo = getSliceInfo(videoSegment);
            options.uri = `http://localhost:${streamingPort}/streamVideo/${sliceInfo.slice_storage_info.slice_hash}`
            options.method = 'POST';
            options.body = JSON.stringify({
                fileHash,
                fileName: streamInfo.fileName,
                walletAddress,
                p2pAddress,
                streamingAddress: streamInfo.StreamingAddress,
                sign: streamInfo.Sign,
                savePath: streamInfo.savePath,
                sliceInfo
            })
            return options;
        };
        player.ready(function () {
            player.src({
                src: `http://localhost:${streamingPort}/streamVideo/${streamInfo.HeaderFile}`,
                type: 'application/x-mpegURL',
            });
        });
        player.play();
    }

    function getSliceInfo(videoSegment) {
        return streamInfo.SegmentToSliceInfo[videoSegment]
    }

    function httpGetAsync(theUrl, callback)
    {
        const xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState === 4 && xmlHttp.status === 200)
                callback(xmlHttp.responseText);
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.send(null);
    }
</script>
</body>
